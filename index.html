<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LockIn">
    
    <script>
        const manifest = {
            "name": "Lock-In Auditor",
            "short_name": "LockIn",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#020617",
            "theme_color": "#020617",
            "icons": [{
                "src": "https://cdn-icons-png.flaticon.com/512/1162/1162456.png",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <title>Lock-In Auditor</title>
    <style>
        :root {
            --bg: #020617; --card: #1e293b; --accent: #22c55e;
            --text: #f8fafc; --muted: #64748b; --border: #334155;
        }
        body {
            margin: 0; font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg); color: var(--text); padding: 20px;
            line-height: 1.5; -webkit-tap-highlight-color: transparent;
        }
        .container { max-width: 450px; margin: 0 auto; display: none; }
        
        #onboarding {
            position: fixed; inset: 0; background: var(--bg); z-index: 100;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal {
            background: var(--card); border-radius: 20px; padding: 24px;
            width: 100%; border: 1px solid var(--border); text-align: center;
        }
        
        .platform-badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            background: rgba(34, 197, 94, 0.1); border: 1px solid var(--accent);
            color: var(--accent); font-size: 10px; font-weight: 800;
            text-transform: uppercase; margin-bottom: 12px; letter-spacing: 1px;
        }

        .guide-box {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px;
            margin: 20px 0; border: 1px dashed var(--border);
        }

        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .sensor-box {
            background: #000; border-radius: 12px; padding: 15px;
            border: 1px solid var(--border); text-align: center;
        }
        .sensor-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 5px; }
        .sensor-val { font-family: monospace; font-size: 20px; color: var(--accent); }

        button {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.2s;
            background: var(--accent); color: #000;
        }
        .btn-report { background: #3b82f6; color: white; margin-top: 10px; }
        
        /* Specific styles for the Canvas Preview button */
        .btn-preview { 
            background: transparent; 
            border: 1px solid var(--muted); 
            color: var(--muted); 
            margin-top: 15px;
            font-size: 12px;
            padding: 10px;
        }

        #reportModal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 200; padding: 20px; align-items: center; justify-content: center;
        }
        .report-content {
            background: var(--card); border-radius: 20px; padding: 24px;
            width: 100%; max-width: 400px; border: 1px solid var(--border);
        }
        .report-line { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .tag-yes { color: var(--accent); font-weight: bold; }
        .tag-no { color: var(--muted); }
    </style>
</head>
<body>

<div id="onboarding">
    <div class="modal">
        <div id="platformStatus" class="platform-badge">Detecting...</div>
        <h2 style="color:#fff; margin-top: 5px;">Integrity Check</h2>
        <p style="font-size: 14px; color: var(--muted)">Hardware sensors are restricted in browsers.<br>Run LockIn from your home screen to audit.</p>
        
        <div class="guide-box" id="platformInstructions">
            Checking compatibility...
        </div>
        
        <p style="font-size: 11px; color: var(--muted)">The app will unlock automatically once opened from your home screen.</p>
        
        <!-- Temporary Preview Button for Canvas -->
        <button id="previewBtn" class="btn-preview" onclick="forceEnter()">[Canvas Preview] Skip Install Check</button>
        
        <button id="continueBtn" style="display:none; margin-top:15px;" onclick="enterApp()">Continue to Auditor</button>
    </div>
</div>

<div class="container" id="mainApp">
    <header style="margin-bottom: 25px;">
        <h1 style="font-size: 24px; margin: 0 0 5px 0;">Hardware Auditor</h1>
        <p style="color: var(--muted); font-size: 13px;">Motion & Haptic Integrity Check</p>
    </header>

    <div class="sensor-grid">
        <div class="sensor-box">
            <div class="sensor-label">Gyroscope (Tilt)</div>
            <div id="valGyro" class="sensor-val">--</div>
        </div>
        <div class="sensor-box">
            <div class="sensor-label">Accel (Force)</div>
            <div id="valAccel" class="sensor-val">--</div>
        </div>
    </div>

    <button id="vibrateBtn" onclick="testVibrate()">Test Vibration Pulse</button>
    <button class="btn-report" onclick="showReport()">Show Capability Report</button>
    
    <button style="margin-top:30px; background:#334155; color:#94a3b8; font-size:12px;" onclick="location.reload()">Reset to Onboarding</button>
</div>

<div id="reportModal">
    <div class="report-content">
        <h2 style="margin-bottom: 20px;">Device Capabilities</h2>
        <div id="reportData"></div>
        <button style="margin-top: 20px;" onclick="document.getElementById('reportModal').style.display='none'">Dismiss</button>
    </div>
</div>

<script>
    const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    
    let caps = {
        vibrate: false,
        gyro: false,
        accel: false
    };

    function updateOnboarding() {
        const badge = document.getElementById('platformStatus');
        const guide = document.getElementById('platformInstructions');
        const continueBtn = document.getElementById('continueBtn');
        const ua = navigator.userAgent.toLowerCase();
        
        let platform = "Desktop/Unknown";
        let instruction = "Browser Menu → <strong>Install App</strong>";

        if (/iphone|ipad|ipod/.test(ua)) {
            platform = "iOS / iPadOS";
            instruction = `Tap <span style="color:#3b82f6">Share</span> then<br><strong>"Add to Home Screen"</strong>`;
        } else if (/android/.test(ua)) {
            platform = "Android Device";
            instruction = `Tap <span style="color:var(--accent)">Menu (⋮)</span> then<br><strong>"Install App"</strong>`;
        } else if (/macintosh/.test(ua)) {
            platform = "macOS";
        }

        badge.innerText = `${platform} • ${isStandalone ? 'INSTALLED' : 'BROWSER'}`;
        guide.innerHTML = instruction;

        if (isStandalone) {
            continueBtn.style.display = 'block';
            document.getElementById('previewBtn').style.display = 'none';
            guide.innerHTML = `<span style="color:var(--accent)">✔ System Verified</span><br>App is running in standalone mode.`;
        }
    }

    // Temporary force entry for testing in Canvas
    function forceEnter() {
        document.getElementById('onboarding').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        initHardware();
    }

    function enterApp() {
        if (isStandalone) {
            forceEnter();
        }
    }

    // Auto-enter if already installed
    if (isStandalone) {
        enterApp();
    } else {
        updateOnboarding();
    }

    function initHardware() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(res => { 
                if (res === 'granted') bindListeners(); 
            }).catch(err => console.log("Permission rejected or needs user gesture"));
        } else {
            bindListeners();
        }
    }

    function bindListeners() {
        window.addEventListener('deviceorientation', (e) => {
            if (e.beta !== null) {
                document.getElementById('valGyro').innerText = Math.round(e.beta) + "°";
                caps.gyro = true;
            }
        }, true);
        
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if (acc && acc.x !== null) {
                const force = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.80665;
                document.getElementById('valAccel').innerText = force.toFixed(1) + "G";
                caps.accel = true;
            }
        }, true);
    }

    function testVibrate() {
        if (navigator.vibrate) { 
            const success = navigator.vibrate([200, 100, 200]);
            if (success) {
                caps.vibrate = true;
                const btn = document.getElementById('vibrateBtn');
                btn.innerText = "Pulse Sent ✓";
                btn.style.background = "#166534";
                btn.style.color = "white";
            }
        } else {
            // Visual feedback if vibration isn't supported in browser
            const btn = document.getElementById('vibrateBtn');
            btn.innerText = "Haptics Blocked by Browser";
            btn.style.background = "#991b1b";
            btn.style.color = "white";
        }
    }

    function showReport() {
        const reportBody = document.getElementById('reportData');
        reportBody.innerHTML = `
            <div class="report-line"><span>Vibration (Haptic)</span> <span class="${caps.vibrate ? 'tag-yes' : 'tag-no'}">${caps.vibrate ? 'TESTED' : 'NOT TESTED'}</span></div>
            <div class="report-line"><span>Gyroscope (Tilt)</span> <span class="${caps.gyro ? 'tag-yes' : 'tag-no'}">${caps.gyro ? 'ACTIVE' : 'INACTIVE'}</span></div>
            <div class="report-line"><span>Accel (Motion)</span> <span class="${caps.accel ? 'tag-yes' : 'tag-no'}">${caps.accel ? 'ACTIVE' : 'INACTIVE'}</span></div>
        `;
        document.getElementById('reportModal').style.display = 'flex';
    }
</script>

</body>
</html>
